name: Publish to PyPI

on:
  push:
    tags:
      - "v*"
jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Create virtual environment
        run: uv venv

      - name: Install dependencies
        run: |
          uv pip install -e .[all]

      - name: Validate tag matches pyproject.toml version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          TOML_VERSION=$(python - <<'EOF'
          import tomllib
          with open("pyproject.toml", "rb") as f:
              print(tomllib.load(f)["project"]["version"])
          EOF
          )

          echo "Tag version: $TAG_VERSION"
          echo "pyproject.toml version: $TOML_VERSION"

          if [ "$TAG_VERSION" != "$TOML_VERSION" ]; then
            echo "❌ Version mismatch!"
            exit 1
          fi

          echo "✓ Versions match."

      - name: Validate changelog contains release version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          if ! grep -q "## $TAG_VERSION" CHANGELOG.md; then
            echo "❌ CHANGELOG.md missing entry for version $TAG_VERSION"
            exit 1
          fi
          echo "✓ Changelog entry found."

      - name: Ensure tag points to main branch
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          git fetch origin main
          TAG_COMMIT=$(git rev-parse HEAD)
          MAIN_COMMIT=$(git rev-parse origin/main)

          echo "Tag commit:  $TAG_COMMIT"
          echo "Main commit: $MAIN_COMMIT"

          if [ "$TAG_COMMIT" != "$MAIN_COMMIT" ]; then
            echo "❌ Tag does not point to main branch!"
            exit 1
          fi

          echo "✓ Tag points to main."


      - name: Build package
        run: uv build

      - name: Publish to PyPI
        run: uv run twine upload --repository-url https://upload.pypi.org/legacy/ dist/* \
          --username "__token__" \
          --password ${{ secrets.PYPI_TOKEN }}
